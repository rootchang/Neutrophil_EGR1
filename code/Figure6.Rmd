---
title: "EGR1 signature is associated with patient outcome in TCGA"
author: "Tiangen Chang  tiangen.chang@nih.gov"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
require(ggplot2)
ggplot2::theme_set(new = theme_bw(base_size = 12)) 
```

# Load packages
```{r, include=FALSE}
library(dplyr)
library(cowplot)
library(patchwork)
library(RColorBrewer)
library(stringr)
library(openxlsx)
library(readxl)
library(readr)
library(gridExtra)
library(survival)
library(survminer)
library(forestplot)
library(GSVA)
library(reshape2)
library(tidyr)
library(scales)
library(msigdbr)
library(VennDiagram)
library(grid)

```

# Map human and mouse genes
```{r}
######### map human genes to mouse genes
mouse_human_genes <- read.csv("http://www.informatics.jax.org/downloads/reports/HOM_MouseHumanSequence.rpt",sep="\t")
# separate human and mouse 
mouse <- split.data.frame(mouse_human_genes,mouse_human_genes$Common.Organism.Name)[[2]]
human <- split.data.frame(mouse_human_genes,mouse_human_genes$Common.Organism.Name)[[1]]
mouse <- mouse[,c(1,4)]
human <- human[,c(1,4)]
# merge the 2 dataset 
mh_data <- merge.data.frame(mouse,human,by = "DB.Class.Key",all.y = TRUE) 

```

# Load gene set, gene expression and clinical data
```{r}
# Load gene set 
gene_set_list_clean <- read.csv(paste0(data_dir, "signature_gene_sets.csv"))

# Load expression data
geneExpr_TCGA <- readRDS(paste0(TCGA_data_dir, "TCGA_RSEM_gene_TPM.rds"))
geneExpr_df <- data.frame(t(geneExpr_TCGA))
geneExpr_df$SampleID <- gsub("\\.", "-", colnames(geneExpr_TCGA))
geneExpr_df <- geneExpr_df[, !grepl("^ENSG", colnames(geneExpr_df))]

# Load and clean clinical data
clinicInfo_TCGA_df <- read.table(
  file = paste0(TCGA_data_dir, "Survival_SupplementalTable_S1_20171025_xena_sp.txt"),
  header = TRUE, sep = "\t"
)[, c(1:5, 7, 9, 26:33)]

colnames(clinicInfo_TCGA_df) <- c(
  "SampleID", "PatientID", "CancerType", "Age", "Sex", "Stage", "Histology",
  "OS_event", "OS_time", "DSS_event", "DSS_time", "DFI_event", "DFI_time", "PFI_event", "PFI_time"
)

predictor_phenotype_TCGA_df0 <- merge(
  geneExpr_df, clinicInfo_TCGA_df, by = "SampleID", all.x = TRUE
)
predictor_phenotype_TCGA_df0 <- predictor_phenotype_TCGA_df0[!is.na(predictor_phenotype_TCGA_df0$CancerType), ]
predictor_phenotype_TCGA_df0 <- predictor_phenotype_TCGA_df0[order(predictor_phenotype_TCGA_df0$CancerType), ]
predictor_phenotype_TCGA_df0 <- predictor_phenotype_TCGA_df0[!grepl("-11$|-12$|-06$|-07$", predictor_phenotype_TCGA_df0$SampleID), ]

gsva_scores_list <- list()
cancer_types <- unique(predictor_phenotype_TCGA_df0$CancerType)

for (ct in cancer_types) {
  message(paste(ct, "in processing..."))
  sub_df <- predictor_phenotype_TCGA_df0[predictor_phenotype_TCGA_df0$CancerType == ct, ]
  pseudobulk_mat <- as.matrix(t(sub_df[, 2:32904]))
  gsva_scores <- gsva(pseudobulk_mat, gene_set_list_clean, method = "gsva")
  gsva_scores_df <- data.frame(t(gsva_scores))
  gsva_scores_df$CancerType_rep2 <- ct
  gsva_scores_list[[ct]] <- gsva_scores_df
}
gsva_scores_allCancers_df <- do.call(rbind, gsva_scores_list)
rownames(gsva_scores_allCancers_df) <- NULL
colnames(gsva_scores_allCancers_df)[1:(ncol(gsva_scores_allCancers_df) - 1)] <- paste0(colnames(gsva_scores_allCancers_df)[1:(ncol(gsva_scores_allCancers_df) - 1)], "_gsva")
write.csv(gsva_scores_allCancers_df, file = paste0(TCGA_data_dir, "gsva_scores.csv"))

predictor_phenotype_TCGA_df0 <- cbind(predictor_phenotype_TCGA_df0, gsva_scores_allCancers_df)

```

# Fig 6A - EGR1 signature correlations with inferred neutrophil abundance from TCGA-HNSC
```{r}
gene_sig_fn <- paste0(input_dir,"gene_signatures.xlsx")
gene_df <- read.xlsx(gene_sig_fn)
gene_set_list_clean <- lapply(gene_df, function(x) {
  x[!is.na(x)]  
})
EGR1_sig <- gene_set_list_clean["EGR1_sig2_pos_5"]

sub_df <- predictor_phenotype_TCGA_df0[predictor_phenotype_TCGA_df0$CancerType == "HNSC", ]
pseudobulk_mat <- as.matrix(t(sub_df[, 2:32904]))
gsva_scores <- gsva(pseudobulk_mat, EGR1_sig, method = "gsva")

gsva_scores <- as.data.frame(t(gsva_scores))
gsva_scores$cell_type <- sub_df$SampleID

TCGA_cellRatios_TIMER2 = read.csv(paste0(input_dir,"infiltration_estimation_for_tcga.csv"), check.names = F)
TCGA_cellRatios_TIMER2 <- merge(TCGA_cellRatios_TIMER2, gsva_scores, by = "cell_type")

# Data and inputs
all_info <- TCGA_cellRatios_TIMER2[, !grepl("_std", colnames(TCGA_cellRatios_TIMER2)), drop = FALSE]
gene_tests <- c("B cell_TIMER", "T cell CD4+_TIMER", "T cell CD8+_TIMER", "Neutrophil_TIMER", "Macrophage_TIMER", "Myeloid dendritic cell_TIMER")

# Initialize results data frame
results <- data.frame(
  Gene = gene_tests,
  SCC = NA,
  SCC_p = NA
)

# Compute Spearman correlations
for (gene in gene_tests) {
  scc_test <- cor.test(all_info[[gene]], all_info$EGR1_sig2_pos_5, method = "spearman", exact = FALSE)
  results[results$Gene == gene, c("SCC", "SCC_p")] <- c(scc_test$estimate, scc_test$p.value)
}
results$SCC_p <- pmax(1e-50, results$SCC_p)
# Adjust p-values
results$SCC_p_adj <- p.adjust(results$SCC_p, method = "bonferroni")
# Prepare data
results$log10_p_adj <- -log10(results$SCC_p_adj)
heatmap_df <- data.frame(
  Metric = "SCC",
  Gene = results$Gene,
  Correlation = results$SCC,
  log10_p_adj = results$log10_p_adj
)
# Rank genes
heatmap_df$Gene <- factor(heatmap_df$Gene, levels = heatmap_df$Gene[order(heatmap_df$Correlation, decreasing = F)])

# Plot
pdf(paste0(fig_dir, "EGR1sig_CellRatio_SCC_TCGA_HNSC_Dotplot.pdf"), width = 5, height = 4)
ggplot(heatmap_df, aes(x = Metric, y = Gene)) +
  geom_point(aes(size = log10_p_adj, fill = Correlation), shape = 21, color = "black", stroke = 0.4) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0, limits = c(-1, 1), name = "Spearman\nCorrelation") +
  scale_size_continuous(name = expression(-log[10](adj.~p)), range = c(2, 8)) +
  theme_minimal(base_size = 14) +
  labs(title = "", x = "", y = "") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black"),
    axis.text.y = element_text(color = "black"),
    panel.grid = element_blank(),
    legend.key.height = unit(0.6, "cm"),
    legend.key.width = unit(0.6, "cm")
  )
dev.off()

```

# Fig 6B (SFig 8C,E) - Kaplan-Meier survival analysis (TCGA-HNSC, EGR1 signature)
```{r}
VarOfInterest <- "EGR1_sig2_pos_5_gsva"
cutoff <- 0.67

# Subset HNSC samples
data_plot <- predictor_phenotype_TCGA_df0[predictor_phenotype_TCGA_df0$CancerType == "HNSC", ]
data_plot$Age <- NULL
data_plot$Sex <- NULL
TCGA_clinicalInfo_df = read.csv('TCGA_HNSC_clinicalInfo_tumor.txt', header=TRUE, row.names = 1, sep = '\t')
TCGA_clinicalInfo_df$Age = TCGA_clinicalInfo_df$age_at_initial_pathologic_diagnosis
TCGA_clinicalInfo_df$Sex = TCGA_clinicalInfo_df$gender
TCGA_clinicalInfo_df$Stage = TCGA_clinicalInfo_df$Neoplasm.Disease.Stage.American.Joint.Committee.on.Cancer.Code
TCGA_clinicalInfo_df$HPV = TCGA_clinicalInfo_df$Subtype

TCGA_clinicalInfo_df$HPV[TCGA_clinicalInfo_df$HPV=="HNSC_HPV-"] = "HPV-"
TCGA_clinicalInfo_df$HPV[TCGA_clinicalInfo_df$HPV=="HNSC_HPV+"] = "HPV+"
TCGA_clinicalInfo_df$HPV[is.na(TCGA_clinicalInfo_df$HPV)] = "Unknown"
TCGA_clinicalInfo_df$Stage[TCGA_clinicalInfo_df$Stage %in% c("STAGE IVA", "STAGE IVB", "STAGE IVC")] = "Stage IV"
TCGA_clinicalInfo_df$Stage[TCGA_clinicalInfo_df$Stage %in% c("STAGE I", "STAGE II", "STAGE III")] = "Stage I-III"
TCGA_clinicalInfo_df$Stage[is.na(TCGA_clinicalInfo_df$Stage)] = "Unknown"

TCGA_clinicalInfo_df = TCGA_clinicalInfo_df[c("Stage", "HPV")]
TCGA_clinicalInfo_df$PatientID = rownames(TCGA_clinicalInfo_df)

data_plot <- merge(data_plot, TCGA_clinicalInfo_df, by.x = "SampleID", by.y = "PatientID")

# Time unit conversion
data_plot$OS_time <- data_plot$OS_time / 30
data_plot$PFI_time <- data_plot$PFI_time / 30
data_plot0 <- data_plot

## test on all HNSC samples or only HPV+/- samples
data_plot <- data_plot0#[data_plot0$HPV == "HPV+", ] # "HPV-", "HPV+"  

# Group assignment
data_plot$Var_score <- ifelse(data_plot[[VarOfInterest]] > quantile(data_plot[[VarOfInterest]], cutoff), "High", "Low")
data_plot$Var_score <- factor(data_plot$Var_score, levels = c("Low", "High"))

##### OS Survival Analysis
os_data <- na.omit(data.frame(Score = data_plot$Var_score, OS_Months = data_plot$OS_time, OS_Event = data_plot$OS_event))
sfit <- survfit(Surv(OS_Months, OS_Event) ~ Score, data = os_data)
scox <- coxph(Surv(OS_Months, OS_Event) ~ Score, data = os_data)
HR <- round(summary(scox)$coefficients[2], 2)
CI <- exp(confint(scox))
P <- round(summary(scox)$coefficients[5], 3)

# Plot
survp <- ggsurvplot(
  sfit, data = os_data,
  palette = c("#00305d", "#9c1915"),
  size = 1, conf.int = FALSE,
  legend.labs = c("Low", "High"), legend.title = "",
  xlab = "Time (months)", ylab = "OS probability",
  break.time.by = 50, risk.table = TRUE, risk.table.height = 0.25,
  risk.table.pos = "out", risk.table.col = "black",
  legend = c(0.65, 0.9), font.tickslab = 12,
  ggtheme = theme_classic()
) 
survp$plot <- survp$plot+ 
            ggplot2::annotate("text", x = 0, y = 0.15, label = paste0("HR = ", HR, " (", round(CI[1], 2), "-", round(CI[2], 2), ")\np = ", P), size = 5, hjust = 0)
pdf(paste0(result_fig_dir, "KM_curve_TCGA_HNSC_EGR1sig_OS.pdf"),width=3.3, height=3)
print(survp, newpage = FALSE)
dev.off()

##### PFS Survival Analysis
pfs_data <- na.omit(data.frame(Score = data_plot$Var_score, PFS_Months = data_plot$PFI_time, PFS_Event = data_plot$PFI_event))
sfit <- survfit(Surv(PFS_Months, PFS_Event) ~ Score, data = pfs_data)
scox <- coxph(Surv(PFS_Months, PFS_Event) ~ Score, data = pfs_data)
HR <- round(summary(scox)$coefficients[2], 2)
CI <- exp(confint(scox))
P <- round(summary(scox)$coefficients[5], 3)

pdf(paste0(result_fig_dir, "KM_curve_TCGA_HNSC_EGR1sig_PFS.pdf"), width = 3.3, height = 3)
ggsurvplot(
  sfit, data = pfs_data,
  palette = c("#00305d", "#9c1915"),
  size = 1, conf.int = FALSE,
  legend.labs = c("Low", "High"), legend.title = "",
  xlab = "Time (months)", ylab = "PFS probability",
  break.time.by = 50, risk.table = TRUE, risk.table.height = 0.25,
  risk.table.pos = "out", risk.table.col = "black",
  legend = c(0.65, 0.9), font.tickslab = 12,
  ggtheme = theme_classic()
) + annotate("text", x = 0, y = 0.15, label = paste0("HR = ", HR, " (", round(CI[1], 2), "-", round(CI[2], 2), ")\np = ", P), size = 5, hjust = 0)
dev.off()

```

# Fig 6C (SFig 8D) - Multivariable forest plot (EGR1 signature + clinical covariates)
```{r}
# Extract clinical variables and outcome for HNSC
columns_keep <- c("EGR1_sig2_pos_5_gsva", "OS_time", "OS_event", "PFI_time", "PFI_event", "Age", "Sex", "Stage", "HPV")
data_plot <- predictor_phenotype_TCGA_df0[predictor_phenotype_TCGA_df0$CancerType == "HNSC", ]
data_plot <- merge(data_plot, TCGA_clinicalInfo_df[c(1,2,3,4,9)], by.x = "SampleID", by.y = "PatientID")
data_plot <- data_plot[columns_keep]
data_plot <- data_plot[data_plot$Stage != "Unknown" & data_plot$HPV != "Unknown", ]

# Initialize result container
result_df <- data.frame(
  Variable = c("EGR1 sig.", "Age", "Sex", "Stage", "HPV"),
  HR_OS = NA, HR_OS_low = NA, HR_OS_up = NA, p_val_OS = NA,
  HR_PFS = NA, HR_PFS_low = NA, HR_PFS_up = NA, p_val_PFS = NA
)

# Binary split
Score <- ifelse(data_plot$EGR1_sig2_pos_5_gsva > quantile(data_plot$EGR1_sig2_pos_5_gsva, 0.67), "High", "Low")
Score <- factor(Score, levels = c("Low", "High"))

# OS model
cancerData_OS <- data.frame(Score, data_plot[, c("Age", "Sex", "Stage", "HPV", "OS_time", "OS_event")])
scox_OS <- coxph(Surv(OS_time, OS_event) ~ Score + Age + Sex + Stage + HPV, data = cancerData_OS)
scox_coef_OS <- summary(scox_OS)$coefficients

# PFS model
cancerData_PFS <- data.frame(Score, data_plot[, c("Age", "Sex", "Stage", "HPV", "PFI_time", "PFI_event")])
scox_PFS <- coxph(Surv(PFI_time, PFI_event) ~ Score + Age + Sex + Stage + HPV, data = cancerData_PFS)
scox_coef_PFS <- summary(scox_PFS)$coefficients

# Store results
result_df[, 2:5] <- cbind(scox_coef_OS[, "exp(coef)"], confint(scox_OS)[,1], confint(scox_OS)[,2], scox_coef_OS[, "Pr(>|z|)"])
result_df[, 6:9] <- cbind(scox_coef_PFS[, "exp(coef)"], confint(scox_PFS)[,1], confint(scox_PFS)[,2], scox_coef_PFS[, "Pr(>|z|)"])

######## Multivariable Forest Plot for OS
plot_data <- tibble::tibble(
  mean = result_df$HR_OS,
  lower = result_df$HR_OS_low,
  upper = result_df$HR_OS_up,
  Variable = result_df$Variable,
  effSize = round(result_df$HR_OS, 3),
  pval = sapply(result_df$p_val_OS, function(p) if (p >= 0.1) round(p, 2) else format(p, scientific = TRUE, digits = 2))
)

# Plot
pdf_file <- paste0(result_fig_dir, "Forest_TCGA_HNSC_EGR1sig_clinicalVARs_MHR_OS.pdf")
pdf(pdf_file, width = 4.4, height = 3.9)
plot_data %>%
  forestplot(labeltext = c("effSize", "Variable", "pval"),
             graph.pos = 3, boxsize = 0.35,
             vertices = TRUE, clip = c(0, 3),
             xlog = FALSE, zero = 1, xticks = c(0, 1, 2),
             txt_gp = fpTxtGp(ticks = gpar(cex = 1.2),
                              label = gpar(cex = 1.2),
                              xlab = gpar(cex = 1.2)),
             xlab = "HR of OS", graphwidth = unit(3, "cm"),
             lineheight = unit(2, "cm")) %>%
  fp_set_style(box = "black", line = "black") %>%
  fp_add_header(
    effSize = "HR" |> fp_txt_plain() |> fp_align_left(),
    Variable = "Variable" |> fp_txt_plain() |> fp_align_left(),
    pval = "P-value" |> fp_txt_plain() |> fp_align_right()
  )
dev.off()

######## Multivariable Forest Plot for PFS
plot_data <- tibble::tibble(
  mean = result_df$HR_PFS,
  lower = result_df$HR_PFS_low,
  upper = result_df$HR_PFS_up,
  Variable = result_df$Variable,
  effSize = round(result_df$HR_PFS, 3),
  pval = sapply(result_df$p_val_PFS, function(p) if (p >= 0.1) round(p, 2) else format(p, scientific = TRUE, digits = 2))
)

pdf_file <- paste0(result_fig_dir, "Forest_TCGA_HNSC_EGR1sig_clinicalVARs_HR_PFS.pdf")
pdf(pdf_file, width = 4.4, height = 3.9)
plot_data %>%
  forestplot(labeltext = c("effSize", "Variable", "pval"),
             graph.pos = 3, boxsize = 0.35,
             vertices = TRUE, clip = c(0, 3),
             xlog = FALSE, zero = 1, xticks = c(0, 1, 2),
             txt_gp = fpTxtGp(ticks = gpar(cex = 1.2),
                              label = gpar(cex = 1.2),
                              xlab = gpar(cex = 1.2)),
             xlab = "HR of PFS", graphwidth = unit(3, "cm"),
             lineheight = unit(2, "cm")) %>%
  fp_set_style(box = "black", line = "black") %>%
  fp_add_header(
    effSize = "HR" |> fp_txt_plain() |> fp_align_left(),
    Variable = "Variable" |> fp_txt_plain() |> fp_align_left(),
    pval = "P-value" |> fp_txt_plain() |> fp_align_right()
  )
dev.off()

```

# SFig 8F - Forest plot of OS versus EGR1 signatures with various cutoffs
```{r}
signatures_test <- c("EGR1_sig2_pos_5_gsva", "EGR1_sig2_pos_10_gsva", "EGR1_sig2_pos_20_gsva", "EGR1_sig2_pos_30_gsva")
signatures_showName <- c("EGR1 sig. (logFC>0.5)", "EGR1 sig2. (logFC>1)", "EGR1 sig3. (logFC>2)", "EGR1 sig4. (logFC>3)")

data_all <- predictor_phenotype_TCGA_df0[c(signatures_test, "OS_event", "OS_time", "PFI_event", "PFI_time", "CancerType")]
data_all <- data_all[data_all$CancerType == "HNSC", ]
colnames(data_all) <- c(signatures_showName, "OS_event", "OS_time", "PFS_event", "PFS_time", "CancerType")

# Set analysis params
quantile_cutoff_upper <- 0.67
result_OS_PFS_df <- data.frame()
for (sig in signatures_showName) {
  # OS
  cancerData <- data_all[, c(sig, "OS_event", "OS_time")]
  cancerData <- na.omit(cancerData)
  colnames(cancerData) <- c("Score", "OS_Event", "OS_Time")
  cancerData$Score <- ifelse(cancerData$Score > quantile(cancerData$Score, quantile_cutoff_upper), 1, 0)
  scox <- coxph(Surv(OS_Time, OS_Event) ~ Score, data = cancerData)
  scox_summary <- summary(scox)

  # PFS
  cancerData2 <- data_all[, c(sig, "PFS_event", "PFS_time")]
  cancerData2 <- na.omit(cancerData2)
  colnames(cancerData2) <- c("Score", "PFS_Event", "PFS_Time")
  cancerData2$Score <- ifelse(cancerData2$Score > quantile(cancerData2$Score, quantile_cutoff_upper), 1, 0)
  scox2 <- coxph(Surv(PFS_Time, PFS_Event) ~ Score, data = cancerData2)
  scox2_summary <- summary(scox2)

  result_OS_PFS_df <- rbind(result_OS_PFS_df, data.frame(
    Signature = sig,
    HR_OS = scox_summary$coefficients[2],
    HR_OS_low = scox_summary$conf.int[3],
    HR_OS_up = scox_summary$conf.int[4],
    pval_OS = scox_summary$coefficients[5],
    HR_PFS = scox2_summary$coefficients[2],
    HR_PFS_low = scox2_summary$conf.int[3],
    HR_PFS_up = scox2_summary$conf.int[4],
    pval_PFS = scox2_summary$coefficients[5]
  ))
}

# Prepare plotting data
plot_data <- tibble::tibble(
  mean = result_OS_PFS_df$HR_OS,
  lower = result_OS_PFS_df$HR_OS_low,
  upper = result_OS_PFS_df$HR_OS_up,
  cellType = result_OS_PFS_df$Signature,
  effSize = round(result_OS_PFS_df$HR_OS, 3),
  pval = result_OS_PFS_df$pval_OS
)

# Format p-values
plot_data$pval <- sapply(plot_data$pval, function(p) {
  if (p >= 0.1) round(p, 2) else format(p, scientific = TRUE, digits = 2)
})

# Plot settings
pdf_file <- paste0(result_fig_dir, "Forest_TCGA_HNSC_EGR1_cutoffs_OS.pdf")
pdf(pdf_file, width = 5.5, height = 4)
plot_data %>%
  forestplot(labeltext = c("effSize", "cellType", "pval"),
             graph.pos = 3,
             boxsize = 0.35,
             vertices = TRUE,
             clip = c(0, 3),
             xlog = FALSE,
             zero = 1,
             xticks = c(0, 1, 2),
             txt_gp = fpTxtGp(ticks = gpar(cex = 1.2),
                              label = gpar(cex = 1.2),
                              xlab = gpar(cex = 1.2)),
             xlab = "HR of OS",
             graphwidth = unit(3, "cm"),
             lineheight = unit(2, "cm")) %>%
  fp_set_style(box = "black", line = "black") %>%
  fp_add_header(
    effSize = c("HR") |> fp_txt_plain() |> fp_align_left(),
    cellType = c("Signature") |> fp_txt_plain() |> fp_align_left(),
    pval = c("P-value") |> fp_txt_plain() |> fp_align_right()
  )
dev.off()

```

# Fig 6D - Pan-cancer dot plot of neutrophil signature hazard ratios and p values
```{r}
signatures_test <- c(
  "EGR1_sig2_pos_5_gsva", "EGR1_sig2_neg_5_gsva", "Tumor_vs_Blood_positive_gsva",
  "Tumor_vs_Blood_negative_gsva", "T1_Ng_gsva", "T2_Ng_gsva", "T3_Ng_gsva",
  "HLADR_CD74_neuAtlas_gsva", "Ly6E_neu_gsva", 
  "PMN_MDSC_Veglia_gsva", "MDSC_Alshetaiwi_gsva", "mPMN_MDSC_Pettinella_gsva"
)

signatures_showName <- c(
  "EGR1 sig.", "EGR1 neg. sig.", "Tumor neutro. sig.", "Blood neutro. sig.",
  "T1 neutro. sig.", "T2 neutro. sig.", "T3 neutro. sig.",
  "CD74+ neutro. sig.", "Ly6E neutro. sig.", 
  "PMN-MDSC", "MDSC", "mPMN-MDSC"
)

data_all <- predictor_phenotype_TCGA_df0[, c(signatures_test, "OS_event", "OS_time", "CancerType")]
colnames(data_all) <- c(signatures_showName, "OS_event", "OS_time", "CancerType")
cancer_types <- unique(data_all$CancerType)

# Initialize matrices
result_HR <- matrix(NA, nrow = length(signatures_showName), ncol = length(cancer_types),
                    dimnames = list(signatures_showName, cancer_types))
result_pval <- result_HR

# Run Cox model per signature per cancer type
for (sig in signatures_showName) {
  for (ct in cancer_types) {
    subset_df <- data_all[data_all$CancerType == ct, ]
    subset_df$binary <- ifelse(subset_df[[sig]] >= quantile(subset_df[[sig]], 0.67, na.rm = TRUE), "High", "Low")
    subset_df$binary <- factor(subset_df$binary, levels = c("Low", "High"))
    if (length(unique(subset_df$binary)) > 1) {
      fit <- coxph(Surv(OS_time, OS_event) ~ binary, data = subset_df)
      result_HR[sig, ct] <- summary(fit)$coefficients[1, "exp(coef)"]
      result_pval[sig, ct] <- summary(fit)$coefficients[1, "Pr(>|z|)"]
    }
  }
}

plot_df <- data.frame(
  Signature = rep(rownames(result_HR), times = length(cancer_types)),
  CancerType = rep(cancer_types, each = nrow(result_HR)),
  HR = as.vector(result_HR),
  pval = as.vector(result_pval)
)

plot_df <- plot_df %>%
  mutate(
    logP = ifelse(is.na(pval) | pval >= 0.051, 0, -log10(pval)),
    HR = pmin(HR, quantile(HR, 0.95, na.rm = TRUE)),
    Signature = factor(Signature, levels = rev(signatures_showName))
  )

# Create plot
p <- ggplot(plot_df, aes(x = CancerType, y = Signature)) +
  geom_point(aes(size = logP, fill = HR), shape = 21, color = "black", stroke = 0.2) +
  scale_fill_gradient2(midpoint = 1, low = "blue", mid = "white", high = "red", name = "Hazard Ratio") +
  scale_size_continuous(range = c(0, 5), name = "-log10(p)", breaks = c(0, 1, 2, 3)) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black"),
    axis.text.y = element_text(color = "black"),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(color = "black")
  )

# Save to PDF
pdf(paste0(result_fig_dir, "Neutrophil_signatures_panCancer_HR_dotplot.pdf"), width = 7.5, height = 2.5)
print(p)
dev.off()

```

# SFig 9A - Venn plot showing overlap between gene sets
```{r}
signatures_test <- c(
  "EGR1_sig2_pos_5", "EGR1_sig2_neg_5", "Tumor_vs_Blood_positive",
  "Tumor_vs_Blood_negative", "T1_Ng", "T2_Ng", "T3_Ng",
  "HLADR_CD74_neuAtlas", "Ly6E_neu", 
  "PMN_MDSC_Veglia", "MDSC_Alshetaiwi", "mPMN_MDSC_Pettinella"
)

signatures_showName <- c(
  "EGR1 sig.", "EGR1 neg. sig.", "Tumor neutro. sig.", "Blood neutro. sig.",
  "T1 neutro. sig.", "T2 neutro. sig.", "T3 neutro. sig.",
  "CD74+ neutro. sig.", "Ly6E neutro. sig.", 
  "PMN-MDSC", "MDSC", "mPMN-MDSC"
)

gene_set_list_filtered <- gene_set_list_clean[signatures_test]
names(gene_set_list_filtered) <- signatures_showName

# Define the signatures to compare with EGR1 sig.
comparison_signatures <- c("Tumor neutro. sig.", "T1 neutro. sig.", "T2 neutro. sig.", 
                          "T3 neutro. sig.", "PMN-MDSC", "MDSC", "mPMN-MDSC")

# Function to create a single Venn diagram with percentages
create_venn_with_percentages <- function(set1, set2, name1, name2) {
  set1 <- as.character(set1)
  set2 <- as.character(set2)
  # Calculate overlaps
  intersection <- length(intersect(set1, set2))
  only_set1 <- length(setdiff(set1, set2))
  only_set2 <- length(setdiff(set2, set1))
  total_union <- length(union(set1, set2))
  # Calculate percentages
  pct_intersection <- round((intersection / total_union) * 100, 1)
  pct_only_set1 <- round((only_set1 / total_union) * 100, 1)
  pct_only_set2 <- round((only_set2 / total_union) * 100, 1)
  # Create temporary file for VennDiagram output
  temp_file <- tempfile(fileext = ".png")
  # Create Venn diagram
  venn_plot <- venn.diagram(
    x = list(set1, set2),
    category.names = c(name1, name2),
    filename = NULL,
    output = TRUE,
    fill = c("#FF6B6B", "#4ECDC4"),
    alpha = 0.7,
    col = "black",
    lwd = 2,
    cex = 1.2,
    fontface = "bold",
    cat.cex = 1,
    cat.fontface = "bold",
    cat.dist = c(0.07, 0.07),
    cat.pos = c(-30, 30),
    label = TRUE,
    margin = 0.1
  )
  # Manually update the labels based on percentage
  for (j in seq_along(venn_plot)) {
    grob <- venn_plot[[j]]
    if (inherits(grob, "text")) {
      if (grob$label == as.character(intersection)) {
        venn_plot[[j]]$label <- paste0(pct_intersection, "%")
      } else if (grob$label == as.character(only_set1)) {
        venn_plot[[j]]$label <- paste0(pct_only_set1, "%")
      } else if (grob$label == as.character(only_set2)) {
        venn_plot[[j]]$label <- paste0(pct_only_set2, "%")
      }
    }
  }
  return(venn_plot)
}

# Create individual Venn diagrams
venn_plots <- list()
for (i in seq_along(comparison_signatures)) {
  sig_name <- comparison_signatures[i]
  venn_plot <- create_venn_with_percentages(
    gene_set_list_filtered[["EGR1 sig."]], 
    gene_set_list_filtered[[sig_name]],
    "EGR1 sig.",
    sig_name
  )
  venn_plots[[i]] <- venn_plot
}
pdf(paste0(fig_dir,"gene_signature_venn_diagrams.pdf"), width = 12, height = 9, onefile = TRUE)

grid.arrange(
  grobs = venn_plots,
  ncol = 3,
  nrow = 3,
  top = textGrob("", 
                gp = gpar(fontsize = 16, fontface = "bold"))
)
dev.off()

```

